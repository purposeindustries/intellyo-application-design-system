machine:
  node:
    version: 8.7.0
test:
  override:
    - npm run test
    - cd sc-*-linux32 && ./bin/sc --user $JAMES_SAUCE_LABS_USER_NAME --api-key $JAMES_SAUCE_LABS_ACCES_KEY --readyfile ~/sauce_is_ready:
        background: true
    # Wait for tunnel to be ready
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    - npm run watch:
        background: true
    # Wait for app to be ready
    - wget --retry-connrefused --no-check-certificate -T 30 http://localhost:8000
    #run tests
    - npm run test:e2e
  post:
    # wait for Sauce Connect to close the tunnel
    - killall --wait sc

dependencies:
  pre:
    - echo -e "$NPMRC" >>$HOME/.npmrc
  cache_directories:
    - "cache"
  post:
    - NODE_ENV=production npm run build
    - wget https://saucelabs.com/downloads/sc-4.4.10-linux32.tar.gz
    - tar -xzf sc-4.4.10-linux32.tar.gz

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - npm run deploy
  tagging:
    branch: master
    commands:
      - >
        if [ -n "$RELEASE_TYPE" ]; then
          git config --global user.email "dev@purposeindustries.co"
          git config --global user.name "purpose-bot"
          npm version $RELEASE_TYPE --git-tag-version false
          npm publish
          VERSION=$(node -pe 'require("./package.json").version')
          git add package.json package-lock.json
          git commit --no-verify -m "chore: $RELEASE_TYPE bump to v$VERSION"
          git tag "v$VERSION"
          repo=https://$GITHUB_ACCESS_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME.git;
          git push $repo $CIRCLE_BRANCH &> /dev/null;
          git push --tags $repo &> /dev/null;
        fi
