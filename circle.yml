machine:
  node:
    version: 8.7.0
  environment:
    E2E_OUTPUT: $CIRCLE_TEST_REPORTS/e2e/
    E2E_SCREENSHOTS: $CIRCLE_ARTIFACTS/screenshots/
    E2E_ERRORSHOTS_OUTPUT: $CIRCLE_ARTIFACTS/e2e-errorshots/
    E2EPROFILE: sauceextended
  pre:
    - sudo apt-get install tree
test:
  override:
    - npm run test
    #run tests
    - >
      if [[ $CIRCLE_BRANCH != *"master"* || ! -z $CIRCLE_TAG ]] ; then
        E2EPROFILE=saucelight npm run test:e2e -- --spec e2e/test/every-test/every-test.js
      else
        npm run test:e2e -- --spec e2e/test/every-test/every-test.js
      fi
    #make html form from test result pictures
    - tree -H "https://circle-artifacts.com/gh/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/$CIRCLE_BUILD_NUM/artifacts/0/$CIRCLE_ARTIFACTS" -o $CIRCLE_ARTIFACTS/index.html $CIRCLE_ARTIFACTS

dependencies:
  pre:
    - echo -e "$NPMRC" >>$HOME/.npmrc
  cache_directories:
    - "cache"
  post:
    - NODE_ENV=production npm run build

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - npm run deploy
  tagging:
    branch: master
    commands:
      - >
        if [ -n "$RELEASE_TYPE" ]; then
          git config --global user.email "dev@purposeindustries.co"
          git config --global user.name "purpose-bot"
          npm version $RELEASE_TYPE --git-tag-version false
          npm publish
          VERSION=$(node -pe 'require("./package.json").version')
          git add package.json package-lock.json
          git commit --no-verify -m "chore: $RELEASE_TYPE bump to v$VERSION"
          git tag "v$VERSION"
          repo=https://$GITHUB_ACCESS_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME.git;
          git push $repo $CIRCLE_BRANCH &> /dev/null;
          git push --tags $repo &> /dev/null;
        fi
